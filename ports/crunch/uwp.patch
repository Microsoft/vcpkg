diff --git a/crnlib/CMakeLists.txt b/crnlib/CMakeLists.txt
index c6c2d58d6..a27726ca8 100644
--- a/crnlib/CMakeLists.txt
+++ b/crnlib/CMakeLists.txt
@@ -86,6 +86,8 @@ ENDIF (WIN32)
 
 IF (NOT WIN32)
     set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fPIC")
+ELSE()
+    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /D _CRT_SECURE_NO_WARNINGS")
 ENDIF (NOT WIN32)
 
 add_library(crunch STATIC ${SRCFILES})

diff --git a/crnlib/lzma_7zFile.h b/crnlib/lzma_7zFile.h
index d18f25838..45419ad55 100644
--- a/crnlib/lzma_7zFile.h
+++ b/crnlib/lzma_7zFile.h
@@ -5,8 +5,11 @@
 #define __7Z_FILE_H
 
 #ifdef _WIN32
+#if defined (WINAPI_FAMILY_PARTITION) && !WINAPI_FAMILY_PARTITION(WINAPI_PARTITION_DESKTOP | WINAPI_PARTITION_SYSTEM)
+#else
 #define USE_WINDOWS_FILE
 #endif
+#endif
 
 #ifdef USE_WINDOWS_FILE
 #include <windows.h>
